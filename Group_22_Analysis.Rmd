---
title: "Group_22_Analysis"
author: "Fang Yang, Jonathan Whittle, Kainin Liu, Ziqi Yang and Ziyao Zong"
date: "2023-03-08"
output:
  pdf_document:
    number_sections: yes
  html_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#reading data
data <- read.csv("C:\\Users\\jhono\\Documents\\glasgow\\DAS\\Group Project 2\\dataset22.csv")


#loading libraries
library(tidyverse)
library(moderndive)
library(sjPlot)
library(stats)
library(jtools)
library(GGally)
library(janitor)
library(gridExtra)
library(kableExtra)
library(skimr)
library(mice)
library(Hmisc) 
library(dplyr)
library(glm2)
```

# Introduction {#sec:intro}

We have been tasked with finding out which properties of the furniture influence whether the products price is more than 1000 Saudi Riyals. Here we shall analyse the data provided to us by the company, working with continuous variables for price, width, depth and height as well as categorical variables for category, whether the product is sold online and whether the product is available in multiple colours.

Section \ref{sec:eda} consists of an exploratory data analysis of the data. Section \ref{sec:fda} contains the contains the formal analysis of fitting the GLMs, the model selection and data visualizations resulting from the model selected. Section \ref{sec:con} contains our conclusions.

```{r results = 'hide', echo=FALSE, warning=FALSE, message=FALSE}
#data tidying

#delete the row which both depth, height and width are NA
nas <- c()
coun = 1
for(i in 1:nrow(data)){
  if(is.na(data$depth[i])){
    if(is.na(data$height[i])){
      if(is.na(data$width[i])){
        nas[coun] = i
        coun = coun + 1
      }
    }
    else
      next
  }
  else
    next
}
data <- data[-nas, ]
data = data[, -c(1:2)]
#splitting price into categories expensive yes or no
data$Expensive <- NA
data$Expensive[data$price<1000] <- 0
data$Expensive[data$price>=1000] <- 1
data$Expensive <- factor(data$Expensive, labels=c("No", "Yes"))
#use Multiple Imputation to replace NA values
imp <- mice(data, 5)
#change imp to dataframe
data <- complete(imp, action = 5)

#creating variable volume
data <- data %>%
  mutate(volume= height*depth*width)
data$volume <- as.numeric(data$volume)

#tidying category with irregular symbol
#unique(data$category)
#data[131,1]
data[131,1] = "Cafe furniture"

```

# Exploratory Data Analysis {#sec:eda}

As we are interested in whether a product is sold at more or less than 1000 Riyals, we dichotamised the variable for price into a categorical variable: Expenisive. Products sold for more than 1000 Riyals are denoted "Yes" and products sold for less than 1000 Riyals are denoted "No". Below we provide a summary table \ref{tab:summariesskim} for the numerical data and a table \ref{tab:percentage} showing the proportion of products considered expensive. From the summary table below we can see that the mean price is over 1000 Riyals.

```{r, echo=FALSE, warning=FALSE, message=FALSE,results='markup', fig.show='asis', eval=TRUE, table.pos="H"}
#create ikea_num data for numerical data
ikea_num<-data %>% select(price, depth, height, width)
#summary table
my_skim <- skim_with(numeric = sfl(hist = NULL), 
                    base = sfl(n = length))
my_skim(ikea_num) %>%
  transmute(Variable=skim_variable, n = n, Mean=round(numeric.mean,2), SD=round(numeric.sd,2),
            Min=numeric.p0, Median=numeric.p50,  Max=numeric.p100,
            IQR = numeric.p75-numeric.p50) %>%
  kable(caption = '\\label{tab:summariesskim} Summary statistics 
        of the IKEA Saudi Arabia data') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")

#table for overall expensive
tabyl(data$Expensive) %>%
  kable(caption= '\\label{tab:percentage} Counts and percentages of products sorted by whether they are expensive or not') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")

```

We now turn our attention to which variables influence whether a product is considered expensive or not. From the boxplots, Figure \ref{fig:summary boxplot} below we can see that in terms of the continuous variables width appears to be the most important.

```{r, echo=FALSE, warning=FALSE, message=FALSE,out.width="70%",fig.align = "center",fig.pos = "H",fig.cap="\\label{fig:summary boxplot}  Summary boxplot",fig.show='asis'}
#plots

#boxplot of width and expensive
p1 <- ggplot(data= data, aes(x=width, y = Expensive, na.rm=TRUE)) +
  geom_boxplot(fill ="steelblue") +
  labs(x="Width", y="Expensive", title= "Width of product")

#boxplot of depth and expensive
p2 <- ggplot(data= data, aes(x=depth, y = Expensive, na.rm=TRUE)) +
  geom_boxplot(fill = "steelblue") +
  labs(x="Depth", y="Expensive", title="Depth of product")

#boxplot of height and expensive
p3 <-ggplot(data= data, aes(x=height, y = Expensive, na.rm=TRUE)) +
  geom_boxplot(fill= "steelblue") +
  labs(x="Height", y="Expensive", title="Height of product")

#boxplot of volume and expensive
p4 <-ggplot(data= data, aes(x=volume, y = Expensive, na.rm=TRUE)) +
  geom_boxplot(fill="steelblue") +
  labs(x="Volume", y= "Expensive", title= "Volume of product")
      
grid.arrange(p1, p2, p3, p4 ,ncol=2)
```

Checking the continuous variables for any high collinearity, we see from the scatterplot matrix, Figure \ref{fig:cor} that there is moderate positive correlation between depth and width and also between depth and height. As the strength is only moderate and the correlation between height and depth is very weak, there is not much concern regarding collinearity.

```{r, echo=FALSE, warning=FALSE, message=FALSE,eval = TRUE,out.width="70%",fig.align = "center",fig.pos = "H",fig.cap="\\label{fig:cor} Scatterplot matrix",fig.show='asis'}

#producing ggpairs to check for high collinearity
continuousdata <- data %>%
  select(width, depth, height)

ggpairs(continuousdata, title="Correlation of continous variables") 

```

We created boxplots looking at price for the categorical variables Sold Online and Multiple colours. From these Figure \ref{fig:Price} we can see that furniture being sold in multiple colours makes little impact on price while there is some suggestion that products sold online are more expensive.


```{r, echo=FALSE, warning=FALSE, message=FALSE,eval = TRUE,out.width="70%",fig.align = "center",fig.pos = "H",fig.cap="\\label{fig:Price} Boxplot of price and categorical variables",fig.show='asis'}
#boxplot 
b1<-ggplot(data = data, aes(x = other_colors, y = price, fill = other_colors)) +
  geom_boxplot() +
  labs(x = "Other colours", y = "Price")+
  theme(legend.position="bottom")


b2<-ggplot(data = data, aes(x = sellable_online, y = price, fill = sellable_online)) +
  geom_boxplot() +
  labs(x = "Sellable online", y = "Price")+
  theme(legend.position="bottom")

grid.arrange(b1,b2,ncol=2)
```

From further research of categorical variables, we can see from table \ref{tab:sellable} that as so few products are not sold online, it is unlikely to be influential. And from the barplot, Figure \ref{bar:categorical} as the proportions for expensive are very similar for multiple colours, it is also unlikely to have much influence.

```{r, echo=FALSE, warning=FALSE, message=FALSE, eval = TRUE,out.width="70%",fig.align = "center",fig.pos = "H",fig.cap="\\label{bar:categorical}  Barplot of categorical variables",fig.show='asis'}

#categorical variables

#expensive and multiple colours
#table 
t1 <- data %>% 
  tabyl(Expensive, other_colors) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>%
  kable(caption='\\label{tab:colours} Percentages and counts of products separated whether they have multiple colours ') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
t1
#barplot
bp1 <- ggplot(data, aes(x = other_colors, fill = Expensive, na.rm=TRUE)) +
  geom_bar(stat = "count", position = "dodge") +
  xlab("Other colours") + ylab("Frequency") +
  theme(legend.position="bottom")
#expensive and sold online
#table
t2 <- data %>% 
  tabyl(Expensive, sellable_online) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>%
  kable(caption= '\\label{tab:sellable} Percentages and counts of products separated by whether they are sold online') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
t2
#barplot
bp2 <-ggplot(data, aes(x = sellable_online, fill = Expensive, na.rm=TRUE)) +
  geom_bar(stat = "count", position = "dodge")+
  xlab("Sellable Online") + ylab("Frequency") +
  theme(legend.position= "bottom")
grid.arrange(bp1,bp2,ncol=2)
```

From the plot, Figure \ref{bar:category} we see that categories is likely to be an influential factor. Wardrobes, Sofas and Armchairs and beds in particular have a high proportion of expensive products. Meanwhile Childrens furniture contains no expensive products at all. Some categories contain so few products that they are unlikely to be influential.

```{r, echo=FALSE, warning=FALSE, message=FALSE, eval = TRUE,out.width="70%",fig.align = "center",fig.pos = "H",fig.cap="\\label{bar:category}  Barplot of expensive and not expensive categories",fig.show='asis'}
#expensive and categories
#table
t3 <- data %>% 
  tabyl(category, Expensive) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>%
  kable(caption= '\\label{tab:category} Percentages and counts of products sorted by category') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
t3
#barplot
ggplot(data, aes(y=category,  fill = Expensive, na.rm=TRUE)) +
  geom_bar(stat = "count", position = "dodge", width=0.5) +
  ylab("Category") + xlab("Frequency") +
  theme(legend.position = "bottom") +
  ggtitle("Counts of expensive and not expensive categories")
```

# Formal analysis {#sec:fda}

As the data provided to us had many incomplete observations we used Multiple imputation to give us a nearly complete dataset. Observations with no values for any of height,width and depth wre excluded. We then fitted a GLM using logistic regression using the logit link function. After starting with the full model we dropped non significant terms Sellable_online, category and other_colors. Each time a term was dropped we saw a significant improvement in BIC. We then tried to fit a model with interaction terms but none of these improved the model so we settled on a model including only the main effects of height, width and depth.

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.align = "center",fig.pos = "H" }

#model full
data1<-data %>% select(category, sellable_online, other_colors, depth, height, width, Expensive)
model_full <- glm2(Expensive~., data = data1, family = binomial(link = "logit"))
#summ(model_full)
#AIC= 284.8, BIC= 374.9, least significant term Sellable_online with p-value 0.99

#model without sellable_online
data2<- data %>% select(category, other_colors, depth, height, width, Expensive)
model2 <- glm2(Expensive~., data = data2, family = binomial(link = "logit"))
#summ(model2)
#AIC= 285.8, BIC= 371.8, least significant term category with p-values 0.99

#model without categories
data3 <- data %>% select(other_colors, height, width, depth, Expensive)
model3 <- glm2(Expensive~., data = data3, family = binomial(link = "logit"))
#summ(model3)
#AIC 281.36, BIC 301.83, least significant term other_colors with p-value 0.08

#model without other_colors
data4 <- data %>% select(height, width, depth, Expensive)
model4 <- glm2(Expensive~., data = data4, family = binomial(link = "logit"))
summ(model4)
#AIC 274.28, BIC 290.65, all terms significant

#trying models with an interaction
mod5 <- glm2(Expensive~ height*depth + width,data = data4, family = binomial(link = "logit"))
#summ(mod5)
#AIC 297.80, BIC 318.27
mod6 <- glm2(Expensive~ depth*width + height,data = data4, family = binomial(link = "logit"))
#summ(mod6)
#AIC 296.99, BIC 317.45
mod7 <- glm2(Expensive~ width*height + depth,data = data4, family = binomial(link = "logit"))
#summ(mod7)
#AIC 298.55, BIC 319.02
#none of these models are an improvement so we use model4


```


```{r, echo=FALSE, fig.align='center', warning=FALSE, message=FALSE, results='hide'}
#obtaining coefficients
modcoefs <- round(coef(model4), 2)

#table for 95%CI <----- can't make this format nicely
confint(model4) %>%
  kable()

#plotting log odds
plot_model(model4, show.values = TRUE, transform = NULL,
           title = "Log-Odds", show.p = FALSE)

#adding log odds into data
data <- data %>%
  mutate(logodds.expensive = predict(model4))

#creating odds
model4 %>%
  coef() %>%
  exp()

#plotting odds
plot_model(model4, show.values = TRUE, axis.lim = c(1,1.5),
           title = "Odds (Expensive)", show.p = FALSE)

#adding odds and probabilities to data
data <- data %>%
  mutate(odds.expensive = exp(logodds.expensive)) %>%
  mutate(prob.expensive = fitted(model4))

#plotting probabilities
#height
prob1 <- ggplot(data = data, aes(x = height, y = prob.expensive)) +
  geom_smooth(method="glm", 
              method.args = list(family="binomial"), 
              se = FALSE) +
  labs(x = "height", y = "P(expensive)")
#depth
prob2 <- ggplot(data = data, aes(x = depth, y = prob.expensive)) +
  geom_smooth(method="glm", 
              method.args = list(family="binomial"), 
              se = FALSE) +
  labs(x = "depth", y = "P(expensive)")
#width
prob3 <- ggplot(data = data, aes(x = width, y = prob.expensive)) +
  geom_smooth(method="glm", 
              method.args = list(family="binomial"), 
              se = FALSE) +
  labs(x = "width", y = "P(expensive)")

grid.arrange(prob1,prob2,prob3, ncol=1)
```


# Conclusions {#sec:con}
